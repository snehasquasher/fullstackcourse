# .github/workflows/vercel-set-preview-url.yml
name: Set Vercel Preview URL

on:   
    push:
        branches:
            - test_github_octo_inspired # ðŸŒ¿ You can change this to your desired branch!!
 
jobs:
  set-vercel-preview-url:
    runs-on: ubuntu-latest
    steps:
      
      - name: Set Vercel Preview URL
        id: get-vercel-url
        run: |
          # Set variables
          TEAM_ID=team_ewL8VcOU12xfMn45gOysWq70
          API_TOKEN=tV9xwT1PMZXGomsaPcEJd3Hj
          
          # Fetch the latest deployment
          response=$(curl -s -H "Authorization: Bearer $API_TOKEN" "https://api.vercel.com/v6/deployments?teamId=team_ewL8VcOU12xfMn45gOysWq70")
          
          # Extract the preview URL
          preview_url=$(echo $response | jq -r '.deployments[0].url')
          
          echo "Preview URL: $preview_url"

          # Save the preview URL to a file
          echo "$preview_url" > preview-url.txt
          
          # Set output variable
          echo "preview_url=$preview_url" >> $GITHUB_ENV

      - name: Trigger spur webhook Workflow
        uses: actions/github-script@v6
        with:
          script: |
            const previewUrl = process.env.preview_url;
            github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'spur-git-integration.yaml',
              ref: context.ref,
              inputs: {
                preview_url: previewUrl
              }
            });
